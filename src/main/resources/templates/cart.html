<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <title>Shoppers &mdash; Colorlib e-Commerce Template</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mukta:300,400,700">
  <link rel="stylesheet" href="fonts/icomoon/style.css">

  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/magnific-popup.css">
  <link rel="stylesheet" href="css/jquery-ui.css">
  <link rel="stylesheet" href="css/owl.carousel.min.css">
  <link rel="stylesheet" href="css/owl.theme.default.min.css">


  <link rel="stylesheet" href="css/aos.css">

  <link rel="stylesheet" href="css/style.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <!-- Google Fonts Roboto -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" />
  <!-- MDB -->
  <link rel="stylesheet" href="css/mdb.min.css" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css">

</head>

<body>

  <div class="site-wrap">
    <!-- Include the header fragment -->
    <div th:replace="~{layout/header :: header}"></div>

    <div class="bg-light py-3">
      <div class="container">
        <div class="row">
          <div class="col-md-12 mb-0"><a href="/">Home</a> <span class="mx-2 mb-0">/</span> <strong
              class="text-black">Cart</strong></div>
        </div>
      </div>
    </div>

    <div class="site-section">
      <div class="container">
        <div class="row mb-5">
          <form class="col-md-12" method="post">
            <div class="site-blocks-table">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th class="product-thumbnail">Hình ảnh</th>
                    <th class="product-name">Sản phẩm</th>
                    <th class="product-price">Đơn giá</th>
                    <th class="product-quantity">Số lượng</th>
                    <th class="product-total">Tổng</th>
                    <th class="product-remove">Xóa</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="product-row" th:each="entry : ${cart.getCartItems().entrySet()}"
                    th:data-product-id="${entry.value.getId}">
                    <td class="product-thumbnail">
                      <img th:src="@{/img/product/__${entry.value.getId}__/__${entry.value.getImage}__}" alt="Image"
                        class="img-fluid">
                    </td>
                    <td class="product-name">
                      <h2 th:text="${entry.value.getName()}" class="h5 text-black"></h2>
                    </td>
                    <td th:text="${#numbers.formatDecimal(entry.value.getPrice(), 0, 'COMMA', 0, 'POINT')} + ' ₫'">
                    </td>
                    <td>
                      <div class="input-group mb-3" style="max-width: 170px;">
                        <div class="input-group-prepend">
                          <button class="btn btn-outline-primary js-btn-minus" type="button">&minus;</button>
                        </div>
                        <input type="text" class="form-control text-center quantity-input"
                          th:value="${entry.value.getQuantity}"
                          th:max="${productMap.get(entry.value.getId).getQuantity}" placeholder=""
                          aria-label="Example text with button addon" aria-describedby="button-addon1">
                        <div class="input-group-append">
                          <button class="btn btn-outline-primary js-btn-plus" type="button">&plus;</button>
                        </div>
                      </div>
                    </td>
                    <td
                      th:text="${#numbers.formatDecimal(entry.value.getPrice() * entry.value.getQuantity(), 0, 'COMMA', 0, 'POINT') + ' ₫'}">
                    </td>
                    <td>
                      <a th:href="@{/cart/delete/__${entry.value.getId}__}" class="btn btn-primary btn-sm">X</a>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </form>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="row mb-5">
              <div class="col-md-6 mb-3 mb-md-0">
                <button class="btn btn-primary btn-sm btn-block" id="cart-update">Cập nhật giỏ hàng</button>
              </div>
              <div class="col-md-6">
                <button class="btn btn-outline-primary btn-sm btn-block">Tiếp tục mua sắm</button>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">
                <label class="text-black h4" for="coupon">Mã giảm giá</label>
                <p>Nếu bạn có phiếu giảm giá hãy nhập ở đây</p>
              </div>
              <div class="col-md-8 mb-3 mb-md-0">
                <input type="text" class="form-control py-3" id="coupon" placeholder="Coupon Code">
              </div>
              <div class="col-md-4">
                <button class="btn btn-primary btn-sm">Apply Coupon</button>
              </div>
            </div>
          </div>
          <div class="col-md-6 pl-5">
            <div class="row justify-content-end">
              <div class="col-md-7">
                <div class="row">
                  <div class="col-md-12 text-right border-bottom mb-5">
                    <h3 class="text-black h4 text-uppercase">Tổng tiền thanh toán</h3>
                  </div>
                </div>
                <!-- <div class="row mb-3">
                  <div class="col-md-6">
                    <span class="text-black">Tổng phụ</span>
                  </div>
                  <div class="col-md-6 text-right">
                    <strong th:text="${#numbers.formatDecimal(cart.calculateTotalPrice, 0, 'COMMA', 0, 'POINT') + ' ₫'}" class="text-black">0 ₫</strong>
                  </div>
                </div> -->
                <div class="row mb-5">
                  <div class="col-md-6">
                    <span class="text-black">Tổng cộng</span>
                  </div>
                  <div class="col-md-6 text-right">
                    <strong
                      th:text="${#numbers.formatDecimal(cart.calculateTotalPrice(), 0, 'COMMA', 0, 'POINT') + ' ₫'}"
                      class="text-black">0 ₫</strong>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-12">
                    <button id="cart-pay" class="btn btn-primary btn-lg py-3 btn-block">Tiến
                      hành thanh toán</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Include the footer fragment -->
    <div th:replace="~{layout/footer :: footer}"></div>
  </div>
  <!-- Nhúng file modals.html -->
  <div th:replace="~{layout/modals}"></div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>
  <!-- MDB -->
  <script type="text/javascript" src="../js/mdb.min.js"></script>

  <script src="../js/jquery-3.3.1.min.js"></script>
  <script src="../js/jquery-ui.js"></script>
  <script src="../js/popper.min.js"></script>
  <script src="../js/bootstrap.min.js"></script>
  <script src="../js/owl.carousel.min.js"></script>
  <script src="../js/jquery.magnific-popup.min.js"></script>
  <script src="../js/aos.js"></script>
  <script src="../js/main.js"></script>
  <script src="../js/user/auth.js"></script>

  <script>
    $('#cart-pay').click(e => {

      location.href = "/cart/pay";

    })
  </script>

  <script th:inline="javascript">
    $('#cart-update').click(e => {
      var cartProducts = [];

      var rows = document.querySelectorAll('.product-row');
      rows.forEach(function (row) {
        var productId = row.getAttribute('data-product-id');
        var productQuantity = row.querySelector('.quantity-input').value;

        cartProducts.push({
          id: productId,
          // name: "",
          quantity: productQuantity,
          // description: "",
          // price: "",
          // image: ""
        });
      });

      var cartProductsJson = JSON.stringify(cartProducts);
      console.log(cartProducts);

      var url = '/cart/update';

      var requestOptions = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: cartProductsJson
      };

      fetch(url, requestOptions)
        .then(response => response.json())
        .then(data => {
          if (data.code === 0) {
            location.href = "";
          }
          console.log(data);
        })
        .catch(error => {
          // Xử lý lỗi (nếu có)
          console.error('Error:', error);
        });
    })

  </script>


</body>

</html>